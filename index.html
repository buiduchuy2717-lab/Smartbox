<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<title>Smart Medicine Box</title>
<style>
/* --- MOBILE-FIRST STYLES --- */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f4f7f6; /* Nền sáng, thân thiện hơn */
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent; /* Loại bỏ hiệu ứng highlight khi chạm */
}

#chat {
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    background: white;
    /* ⭐️ ĐÃ SỬA: Tăng chiều cao tối thiểu lên 85% màn hình */
    min-height: 85vh; 
    display: flex;
    flex-direction: column;
    box-shadow: none;
    padding: 15px;
    box-sizing: border-box;
}

h3 {
    text-align: center;
    color: #007bff;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.5em;
}

/* --- KHU VỰC DỮ LIỆU CẢM BIẾN --- */
#sensor-data {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    padding: 10px 0;
    margin-bottom: 15px;
    background: #e9ecef;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

#sensor-data > div {
    flex-basis: 30%;
    text-align: center;
    font-size: 1.1em;
    padding: 5px;
    color: #343a40;
}

#sensor-data span {
    display: block;
    font-size: 1.4em;
    font-weight: bold;
    color: #17a2b8;
    margin-top: 3px;
}


/* --- KHU VỰC TIN NHẮN --- */
#messages {
    flex-grow: 1; 
    /* ⭐️ ĐÃ SỬA: Tăng chiều cao tối thiểu của khung chat */
    min-height: 450px; 
    overflow-y: auto;
    border: 1px solid #ced4da;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
    background: #ffffff;
}

.msg {
    margin: 8px 0;
    padding: 8px 12px;
    border-radius: 18px;
    max-width: 80%;
    word-wrap: break-word;
    line-height: 1.4;
}

.user {
    background: #007bff;
    color: white;
    align-self: flex-end;
    margin-left: auto;
    border-bottom-right-radius: 2px;
}

.bot {
    background: #e9ecef;
    color: #343a40;
    align-self: flex-start;
    border-bottom-left-radius: 2px;
}

/* Thêm hiệu ứng cho tin nhắn Sensor */
.sensor {
    background: #ffc107;
    color: #212529;
    text-align: center;
    margin-left: auto;
    margin-right: auto;
    max-width: 95%;
    font-style: italic;
    font-size: 0.9em;
    border-radius: 10px;
}

/* --- KHU VỰC INPUT & NÚT GỬI --- */
#input-area {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
}

input {
    flex: 1;
    padding: 12px;
    font-size: 16px;
    border: 1px solid #ced4da;
    border-radius: 25px;
    transition: border-color 0.2s;
}

input:focus {
    border-color: #007bff;
    outline: none;
}

button {
    padding: 12px 20px;
    border: none;
    border-radius: 25px;
    background: #28a745;
    color: white;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    font-weight: bold;
    min-width: 80px;
}

button:hover {
    background: #218838;
}

button:active {
    transform: scale(0.98);
}

#sendSensor {
    width: 100%;
    margin-top: 10px;
    background: #17a2b8;
    border-radius: 10px;
}

#sendSensor:hover {
    background: #138496;
}
</style>
</head>
<body>

<div id="chat">
    <h3><span role="img" aria-label="y tế">⚕️</span>Smart Care</h3>
    
    <div id="sensor-data">
        <div>Thân nhiệt: <span id="ThanNhiet">--</span> °C</div>
        <div>Nhịp tim: <span id="nhipTim">--</span> bpm</div>
        <div>SpO₂: <span id="Sp02">--</span> %</div>
    </div>
    
    <div id="messages"></div>
    
    <div id="input-area">
        <input id="input" placeholder="Nhập tin nhắn..." />
        <button onclick="send()">Gửi</button>
    </div>
    
    <button id="sendSensor">Gửi dữ liệu cảm biến thủ công</button>
</div>

<script>
const API_KEY = "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";

function add(who, text, cls) {
    const msg = document.createElement("div");
    msg.className = "msg " + cls;
    
    // Xử lý hiển thị cho tin nhắn Sensor (có xuống dòng)
    if (cls === 'sensor') {
        const lines = text.split('\n');
        msg.innerHTML = `<strong>${who}:</strong> ${lines.join('<br>')}`;
    } else {
        msg.textContent = who + ": " + text;
    }
    
    document.getElementById("messages").appendChild(msg);
    msg.scrollIntoView({ behavior: 'smooth' });
}

async function send() {
    const input = document.getElementById("input");
    const text = input.value.trim();
    if (!text) return;
    input.value = "";
    sendToGPT("Bạn", text, "user"); // Thêm class user
}

async function sendToGPT(sender, text, cls) { // Cập nhật để nhận class
    add(sender, text, cls);
    try {
        const res = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [{ role: "user", content: text }]
            })
        });
        const data = await res.json();
        const reply = data.choices?.[0]?.message?.content || "(Lỗi API hoặc hết credit)";
        add("AI", reply, "bot");
    } catch (err) {
        add("AI", "⚠️ Lỗi kết nối API", "bot");
        console.error(err);
    }
}
</script>

<script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const thanNhiet = document.getElementById('ThanNhiet');
    const nhipTim = document.getElementById('nhipTim');
    const Sp02 = document.getElementById('Sp02');
    const sendSensorBtn = document.getElementById("sendSensor");

    let configThanNhiet = null, configNhipTim = null, configSpO2 = null;
    let lastValues = { t: null, hr: null, sp: null };
    let stableTimer = null;
    let sentFinal = false;

    const eraWidget = new EraWidget();
    eraWidget.init({
        needRealtimeConfigs: true,
        needHistoryConfigs: false,
        needActions: false,
        onConfiguration: (cfg) => {
            configThanNhiet = cfg.realtime_configs[0];
            configNhipTim = cfg.realtime_configs[1];
            configSpO2 = cfg.realtime_configs[2];
            console.log("Realtime configs:", cfg.realtime_configs);
        },
        onValues: (values) => {
            if (!configThanNhiet || !configNhipTim || !configSpO2) return;

            const t = values[configThanNhiet.id]?.value;
            const hr = values[configNhipTim.id]?.value;
            const sp = values[configSpO2.id]?.value;

            if (t != null) thanNhiet.textContent = t;
            if (hr != null) nhipTim.textContent = hr;
            if (sp != null) Sp02.textContent = sp;

            if (sentFinal) return;

            const changed = t !== lastValues.t || hr !== lastValues.hr || sp !== lastValues.sp;

            if (changed) {
                if (stableTimer) clearTimeout(stableTimer);
                stableTimer = setTimeout(() => {
                    const sensorMsg = `Dữ liệu cảm biến tự động (50s ổn định):\n- Thân nhiệt: ${t} °C\n- Nhịp tim: ${hr} bpm\n- Nồng độ O₂: ${sp}%`;
                    sendToGPT("Sensor", sensorMsg, "sensor"); // Thêm class sensor
                    sentFinal = true;
                }, 50000);
            }

            lastValues = { t, hr, sp };
        }
    });

    // Nút gửi thủ công
    sendSensorBtn.addEventListener("click", () => {
        const t = thanNhiet.textContent;
        const hr = nhipTim.textContent;
        const sp = Sp02.textContent;

        if (t === "--" || hr === "--" || sp === "--") {
            alert("Cảm biến chưa có dữ liệu!");
            return;
        }

        const sensorMsg = `Dữ liệu cảm biến (gửi thủ công):\n- Thân nhiệt: ${t} °C\n- Nhịp tim: ${hr} bpm\n- Nồng độ O₂: ${sp}%`;
        sendToGPT("Sensor", sensorMsg, "sensor"); // Thêm class sensor

        // Nếu chưa gửi tự động thì chặn luôn
        if (!sentFinal) {
            if (stableTimer) clearTimeout(stableTimer);
            sentFinal = true;
        }
    });
});
</script>
</body>
</html>



